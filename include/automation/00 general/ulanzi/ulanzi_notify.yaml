id: c9f96c01-492d-4a18-ad9e-0919e680172b
alias: "00 - Notifications for Ulanzi"
trigger:
  - platform: state
    entity_id: sensor.pixel_7_pro_last_notification
    to: ~
    variables:
      sender_name: !secret name_gf
      send_message: >
        {{
          trigger.to_state.attributes['package'] is defined
          and trigger.to_state.attributes['package'] == 'com.whatsapp'
          and trigger.to_state.attributes['android.title'] == sender_name
        }}
      icon: whatsapp
      text: >
        {% if trigger.to_state.attributes['android.textLines'] is defined %}
          {{ trigger.to_state.attributes['android.textLines'] | last }}
        {% else %}
          {{ trigger.to_state.attributes['android.text'] }}
        {% endif %}
      repeat: 2
      textCase: 2
      pushIcon: 2
  - platform: state
    entity_id: binary_sensor.doorbell_button
    to: "on"
    variables:
      icon: dingdong
      text: Ding Dong!
condition:
  - "{{ send_message | default(true) }}"
action:
  - alias: "Send message to Ulanzi clock"
    service: mqtt.publish
    data:
      qos: 0
      retain: false
      topic: awtrix_dd3300/notify
      payload: >
        {{ dict(
                text=text,
                repeat=repeat | default(3),
                rainbow=rainbow | default(false),
                icon=icon,
                pushIcon=pushIcon | default(0),
                textCase=textCase | default(2)
                ) | to_json
        }}
