platform: template
lights:
  kitchen_osc:
    unique_id: cbf8c5b9-96f1-4dc8-b7e8-45c968fe03b4
    friendly_name: "Kitchen Ceiling"
    level_template: "{{ state_attr('light.kitchen_ceiling', 'brightness') }}"
    value_template: "{{ not is_state('select.kitchen_ceiling_lights_preset', 'uit') }}"
    availability_template: "{{ not states('light.kitchen_ceiling') in ['unavailable', 'unknown'] }}"
    turn_on:
      - alias: "Set light to default preset"
        service: select.select_option
        data:
          entity_id: select.kitchen_ceiling_lights_preset
          option: "50%"
    turn_off:
      - alias: "Activate off preset"
        service: select.select_option
        data:
          entity_id: select.kitchen_ceiling_lights_preset
          option: "uit"
    set_level:
      - variables:
          preset_values: >
            {%- set presets = state_attr('select.kitchen_ceiling_lights_preset', 'options') %}
            {%- set ns = namespace(presets=[]) %}
            {%- for p in presets %}
              {%- set v = 0 if p == 'uit' else p | replace('%', '') | int %}
              {%- set ns.presets = ns.presets + [ { 'preset': p, 'value': (v * 2.55) | round(0) } ] %}
            {%- endfor %}
            {{ ns.presets }}
      - if: >
          {%- set values = preset_values | map(attribute='value') | list %}
          {{ brightness in values }}
        then:
          - alias: "Activate matching preset"
            service: select.select_option
            data:
              entity_id: select.kitchen_ceiling_lights_preset
              option: >
                {{ preset_values | selectattr('value', 'eq', brightness) | map(attribute='preset') | join }}
      - service: light.turn_on
        data:
          entity_id: light.kitchen_ceiling
          brightness: "{{ brightness }}"
