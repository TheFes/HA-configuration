- sensor:
    - unique_id: b7f8ef75-d09d-4dc2-aa14-4e451555b32c
      name: Reject entities
      state: "{{ state_attr('sensor.reject_entities', 'entities') | default([], true) | count }}"
      attributes:
        entities: >
          {{
            [
              "sensor.samsung_soundbar_power_meter",
              "sensor.zolder_bol_power",
              "sensor.wasmachinelamp_power",
              "sensor.electricity_meter_power_production",
              "sensor.pixel_7_pro_battery_power",
              "sensor.tablet_battery_power",
              "sensor.measured_power",
              "sensor.unknown_power",
              "sensor.zolder_mini_marleen_power",
              "sensor.zolder_mini_martijn_power",
              "sensor.power_production_now"
            ]
          }}

    - unique_id: f210bdf4-b8c9-4dca-88a5-12d4ab3ab749
      name: Measured entities
      state: "{{ state_attr('sensor.measured_entities', 'entities') | default([], true) | count }}"
      attributes:
        entities: >
          {%- set reject_entities = state_attr('sensor.reject_entities', 'entities') | default([], true) %}
          {{ states.sensor
              | selectattr('entity_id', 'search', 'power')
              | rejectattr('entity_id', 'in', reject_entities)
              | rejectattr('entity_id', 'in', integration_entities('onesmartcontrol') + integration_entities('dsmr'))
              | rejectattr('entity_id', 'search', 'ble_measured_power|battery')
              | selectattr('attributes.state_class', 'defined')
              | selectattr('attributes.state_class', 'eq', 'measurement')
              | selectattr('state', 'is_number')
              | map(attribute='entity_id')
              | list
          }}

    - unique_id: 6da8e3ab-38a9-4897-89e5-192802ff6894
      name: Measured Power
      unit_of_measurement: "W"
      state_class: measurement
      device_class: power
      state: >
        {%- set entities = state_attr('sensor.measured_entities', 'entities') | default([], true) %}
        {{
          entities
            | map('states')
            | map('float', default=0)
            | sum
            | round(1)
        }}
      attributes:
        using_power: >
          {%- set ns = namespace(power=[]) %}
          {%- for e in state_attr('sensor.measured_entities', 'entities') %}
            {% set i = states[e] %}
            {%- if i.state | is_number and i.state | float > 0 %}
              {%- set ns.power = ns.power + [dict(enitty_id=i.entity_id, name=i.name, state=i.state | float)] %}
            {%- endif %}
          {%- endfor %} 
          {{ ns.power | sort(attribute='state', reverse=true) }}
        not_using_power: >
          {%- set ns = namespace(power=[]) %}
          {%- for e in state_attr('sensor.measured_entities', 'entities') %}
            {% set i = states[e] %}
            {%- if i.state | is_number and i.state | float == 0 %}
              {%- set ns.power = ns.power + [dict(enitty_id=i.entity_id, name=i.name) ] %}
            {%- elif not i.state | is_number %}
              {%- set ns.power = ns.power + [dict(enitty_id=i.entity_id, name=i.name, state=i.state)] %}
            {%- endif %}
          {%- endfor %}
          {{ ns.power }}
      icon: mdi:flash
      availability: "{{ state_attr('sensor.measured_entities', 'entities') | default([], true) | list | count > 0 }}"

    - unique_id: defa0d9f-ce65-4af1-a63e-a1bbe14c4092
      name: Unknown Power
      unit_of_measurement: "W"
      state_class: measurement
      device_class: power
      state: >-
        {{
          [
            0,
            states('sensor.power_consumption') | multiply(1000)
              + states('sensor.electricity_meter_power_production') | float
              - states('sensor.measured_power')| float
          ] | max | round(2)
        }}
      icon: mdi:flash
      availability: >
        {{
          states('sensor.power_consumption') | is_number
          and states('sensor.measured_power') | is_number
          and states('sensor.electricity_meter_power_production') | is_number
        }}
