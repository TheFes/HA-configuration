id: 599d5917-be75-4f9c-a339-6ec71e2610dc
alias: "00 - Set group measured power"
mode: single
trigger:
  - platform: homeassistant
    event: start
  - platform: time_pattern
    minutes: "/5"
action:
  - alias: "Set group"
    service: group.set
    data:
      object_id: measured_power
      entities: >
        {%- set reject_entities = state_attr('group.reject_power', 'entity_id') | list %}
        {{ states.sensor
            | selectattr('entity_id', 'search', '_power') 
            | rejectattr('entity_id', 'search', 'estimated_power')
            | rejectattr('entity_id', 'in', reject_entities)
            | rejectattr('entity_id', 'in', integration_entities('onesmartcontrol'))
            | rejectattr('entity_id', 'in', integration_entities('dsmr'))
            | rejectattr('entity_id', 'search', 'ble_measured_power')
            | selectattr('attributes.state_class', 'defined')
            | selectattr('attributes.state_class', 'eq', 'measurement')
            | selectattr('state', 'is_number')
            | map(attribute='entity_id')
            | list
        }}
