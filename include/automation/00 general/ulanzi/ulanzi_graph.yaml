id: 4bb21af8-4d55-444d-b25d-32cda5990025
alias: "00 - Ulanzi graph"
mode: queued
trigger:
  - platform: state
    entity_id: sensor.neerslag_buienalarm_regen_data
    to: ~
    variables:
      icon: rainy
      graph_data: >
        {% set data = state_attr('sensor.neerslag_buienalarm_regen_data', 'data') %}
        {% set data = data.precip if data is not none else [] %}
        {{ data | map('multiply', 100) | list }}
      graph_type: bar
      graph_color: [0, 0, 255]
      app: notify
      update: "{{ graph_data | sum > 0 }}"
variables:
  plot_graph: "{{ graph_data is defined and graph_data is not string and graph_data is iterable }}"
condition:
  - "{{ update | default(true) | bool(true) }}"
  - "{{ plot_graph or text is defined }}"
action:
  - alias: "Send message to Ulanzi clock"
    service: mqtt.publish
    data:
      qos: 0
      retain: false
      topic: awtrix_dd3300/{{ 'notify' if app | default('notify') == 'notify' else ('custom/' ~ app) }}
      payload: >
        {% set icon = icon | default() %}
        {% set graph_type = graph_type | default('bar') %}
        {% set color = graph_color | default() if plot_graph else text_color | default() %}
        {% set data = (graph_data[:11] if icon else graph_data[:16]) if plot_graph else [] %}
        {% set data = data | select('is_number') | map('round', 0) | map('int') | list %}
        {% set graph_data = { graph_type: (graph_data[:11] if icon else graph_data[:16]) if plot_graph else [] }%}
        {% set text = text if not plot_graph else none %}
        {% set rainbox = rainbow | default(none) %}
        {% set data = dict(graph_data, icon=icon, color=color, text=text, rainbow=rainbow) %}
        {% set data = dict(data.items() | selectattr('1')) %}
        {{ data | to_json }}
