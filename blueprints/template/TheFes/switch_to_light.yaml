blueprint:
  name: Switch to light
  description: >
    Converts a switch to a light
  author: TheFes
  source_url: https://github.com/TheFes/HA-configuration/blob/main/blueprints/template/TheFes/switch_to_light.yaml
  domain: template
  input:
    switch:
      name: Switch
      description: The switch which should be converted
      selector:
        entity:
          multiple: false
          filter:
            - domain: switch
      default: null
    icon_on:
      name: Icon On
      description: Icon to be used when the template light is on
      selector:
        icon:
          placeholder: mdi:lightbulb
      default: mdi:lightbulb
    icon_off:
      name: Icon Off
      description: Icon to be used when the template light is off
      selector:
        icon:
          placeholder: mdi:lightbulb-off
      default: mdi:lightbulb-off
    add_effects:
      name: Add effects
      description: If set to true a Slow Pulse (1 second blink) and Fast Pulse (0.5 seconds) effect
      selector:
        boolean:
      default: true
    default_entity_id:
      name: Default entity_id
      description: The default entity id to use
      selector:
        text:
          multiple: false
          multiline: false

triggers:
  - trigger: state
    entity_id: !input switch
  - trigger: event
    event_type: event_template_reloaded
  - trigger: homeassistant
    event: start

actions:
  variables:
    switch: !input switch
    icon_on: !input icon_on
    icon_off: !input icon_off
    add_effects: !input add_effects

light:
  default_entity_id: !input default_entity_id
  name: "{{ state_attr(switch, 'friendly_name') }}"
  icon: "{{ icon_on if is_state(switch, 'on') else icon_off }}"
  state: >
    {% set current_effect =
      (state_attr('sensor.blink_effect_active', 'blink_active')
        | default({}, true)).get(this.entity_id, 'None')
    %}
    {{
      is_state(switch, 'on')
      or current_effect in ['Slow Pulse', 'Fast Pulse']
    }}
  turn_on:
    - action: switch.turn_on
      target:
        entity_id: "{{ switch }}"
  turn_off:
    - action: switch.turn_off
      target:
        entity_id: "{{ switch }}"
  effect_list: "{{ ['Fast Pulse', 'Slow Pulse', 'None'] if add_effects else none }}"
  effect: >
    {{
      state_attr('sensor.blink_effect_active', 'blink_active')[this.entity_id]
        | default('None') if add_effects else none
    }}
  set_effect:
    if: "{{ add_effects }}"
    then:
      - action: script.turn_on
        target:
          entity_id: script.light_blink
        data:
          variables:
            light: "{{ this.entity_id }}"
            toggle_entity: "{{ switch }}"
            effect: "{{ effect }}"
  availability: "{{ switch | has_value }}"
