# Script to perform blink action
script:
  # script to perform Slow Pulse and Fast Pulse effect for unsupported lights
  light_blink:
    alias: "Light blink"
    mode: parallel
    fields:
      light:
        description: "Select the light"
        name: Light
        example: light.livingroom
        required: true
        selector:
          entity:
            domain: light
            multiple: false
      toggle_entity:
        description: "Select the entity to toggle"
        name: Entity to toggle
        example: switch.livingroom
        required: false
        selector:
          entity:
            multiple: false
      effect:
        description: Effect
        example: Fast Pulse
        required: true
        selector:
          select:
            options:
              - None
              - Fast Pulse
              - Slow Pulse
    sequence:
      - event: light_effect_blink
        event_data:
          light: "{{ light }}"
          effect: "{{ effect }}"
      - delay: 0.1
      - if: "{{ effect not in ['None', None] }}"
        then:
          - alias: Set variables for repeat loop
            variables:
              repeat_max: "{{ 20 if effect == 'Fast Pulse' else 10 }}"
              repeat_delay: "{{ 0.5 if effect == 'Fast Pulse' else 1 }}"
              current_effect: >
                {{
                  (state_attr('sensor.blink_effect_active', 'blink_active')
                    | default({}, true)).get(light, 'None')
                }}
          - alias: "Blink loop"
            repeat:
              while: "{{ repeat.index <= repeat_max and effect == current_effect }}"
              sequence:
                - variables:
                    domain: "{{ toggle_entity.split('.')[0] }}"
                - alias: "Blink"
                  action: "{{ domain }}.toggle"
                  data:
                    entity_id: "{{ toggle_entity }}"
                - alias: "Short delay between toggle"
                  delay: "{{ repeat_delay }}"
                - alias: "Reset current effect variable"
                  variables:
                    current_effect: >
                      {{
                        (state_attr('sensor.blink_effect_active', 'blink_active')
                          | default({}, true)).get(light, 'None')
                      }}
      - alias: Turn on the light
        action: light.turn_on
        target:
          entity_id: "{{ light }}"
      - event: light_effect_blink
        event_data:
          light: "{{ light }}"
template:
  # Template sensor to store lights for which script is active
  - triggers:
      - trigger: event
        event_type: light_effect_blink
    sensor:
      - unique_id: 7b25c899-ec7d-48f3-b9c4-3f7fb7a08a68
        name: Blink Effect Active
        state: OK
        attributes:
          blink_active: >
            {% set current = this.attributes.get('blink_active', {}) %}
            {% set others = dict(current.items() | rejectattr('0', 'eq', trigger.event.data.light)) %}
            {% if trigger.event.data.effect is defined and trigger.event.data.light is defined %}
              {% set add = {trigger.event.data.light: trigger.event.data.effect} %}
              {{ others | combine(add) }}
            {% elif trigger.event.data.light is defined %}
              {{ others }}
            {% else %}
              {{ current }}
            {% endif %}

  # switch to light + add effects
  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.wereldbol
        icon_on: game-icons:globe
        icon_off: game-icons:globe
        add_effects: true
        default_entity_id: light.wereldbol
    unique_id: 780b45cb-4f49-4879-babb-76483c7cab50

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.tuinlampjes
        icon_on: mdi:string-lights
        icon_off: mdi:string-lights-off
        add_effects: true
        default_entity_id: light.tuinlampjes
    unique_id: a5171e0b-ff8b-459d-ba5e-24d25c10bc4e

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.bedlamp_floris
        icon_on: mdi:desk-lamp
        icon_off: mdi:desk-lamp-off
        add_effects: true
        default_entity_id: light.bedlamp_floris
    unique_id: 7a53d2ed-34a8-4f50-bbf8-69987f242d7b

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.bed_pepijn
        icon_on: mdi:string-lights
        icon_off: mdi:string-lights-off
        add_effects: true
        default_entity_id: light.bed_pepijn
    unique_id: 092c7ec4-ef29-47a2-bded-9c5aaafceae7

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.keukenspotjes
        icon_on: mdi:light-recessed
        icon_off: mdi:light-recessed
        add_effects: true
        default_entity_id: light.keukenspotjes
    unique_id: bd5234e0-2e57-435b-aff3-c901585fbe1b

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.tv_lamp
        icon_on: mdi:floor-lamp-dual
        icon_off: mdi:floor-lamp-dual-outline
        add_effects: true
        default_entity_id: light.tv_lamp
    unique_id: 3f079367-7d59-45a5-96f6-a97881472e46

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.shelly_badkamerspiegel_relay
        icon_on: mdi:mirror-rectangle
        icon_off: mdi:mirror-rectangle
        add_effects: true
        default_entity_id: light.badkamerspiegel
    unique_id: 4ba1e527-8550-4118-8e6c-e191273f100c

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.shelly1_technische_ruimte_relay
        icon_on: mdi:wall-sconce-flat
        icon_off: mdi:wall-sconce-flat-outline
        add_effects: true
        default_entity_id: light.technishe_ruimte
    unique_id: 167b02e7-eae5-4203-b964-a09098e0f417

  - use_blueprint:
      path: TheFes/switch_to_light.yaml
      input:
        switch: switch.sonoff_badkamerspiegel_zolder_relay
        icon_on: mdi:wall-sconce-flat
        icon_off: mdi:wall-sconce-flat-outline
        add_effects: true
        default_entity_id: light.badkamerspiegel_zolder
    unique_id: f6ca2c05-ccea-478f-b4f9-e361688e5f5c
