id: dc9ec434-0886-4fd3-a504-006ca6e8ec40
alias: "F1P - Xiaomi button Bed Pepijn"
mode: parallel
max_exceeded: silent
trigger:
  - platform: event
    event_type: "deconz_event"
    event_data:
      device_id: f448ab96c13a02e1e4ed6dc679d693c5
action:
  - alias: "Which click type"
    choose:
      - conditions:
          - alias: "Short"
            condition: template
            value_template: "{{ trigger.event.data.event == 1002 }}"
        sequence:
          - alias: "Perform right action"
            choose:
              - conditions: >
                  {{
                    (
                      is_state('sun.sun', 'below_horizon')
                      or states('sensor.pepijn_lux') | float(0) < 10 
                    )
                    and
                      (
                        now() > today_at(states('input_datetime.pepijn_time_bed'))
                        or now() < today_at(states('input_datetime.pepijn_time_awake'))
                      )
                    and is_state('light.groep_bed_pepijn', 'off') 
                  }}
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: light.graafmachine
                    data:
                      color_name: red
                      brightness: 30
                  - delay: >
                      {% set next = today_at(states('input_datetime.pepijn_time_awake')) - timedelta(minutes =states('input_number.leestijd_pepijn')| int) %}
                      {% set next = next + timedelta(days=1) if now() > next else next %}
                      {{ [12, ((next - now()).seconds / 3600 * 12) | int + 1] | min }}
                  - service: light.turn_off
                    target:
                      entity_id: light.graafmachine
              - conditions: "{{ is_state('light.bed_pepijn', 'off') }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: light.groep_bed_pepijn
                    data:
                      color_temp_kelvin: 3000
                      brightness_pct: 20
            default:
              - service: light.turn_off
                target:
                  entity_id: light.groep_bed_pepijn
      - conditions:
          - alias: "Long"
            condition: template
            value_template: "{{ trigger.event.data.event == 1001 }}"
        sequence:
          - alias: "Turn all lights off"
            service: light.turn_off
            target:
              area_id: slaapkamer_pepijn
      - conditions:
          - alias: "Double"
            condition: template
            value_template: "{{ trigger.event.data.event == 1004 }}"
        sequence: []
      - conditions:
          - alias: "Release"
            condition: template
            value_template: "{{ trigger.event.data.event == 1003 }}"
        sequence: []
