script_start_audio_tag:
  alias: "F0L ðŸ“º Start audio with tag"
  icon: mdi:music
  mode: restart
  max_exceeded: silent
  variables:
    speaker_groups:
      media_player.huis_groep:
        - media_player.keuken_hub
        - media_player.slaapkamer_hub
        - media_player.pepijn_mini
        - media_player.woonkamer_mini
        - media_player.zolder_mini_marleen
        - media_player.zolder_mini_martijn
        - media_player.floris_mini
      media_player.boven_groep:
        - media_player.pepijn_mini
        - media_player.woonkamer_mini
        - media_player.zolder_mini_marleen
        - media_player.zolder_mini_martijn
        - media_player.floris_mini
      media_player.beneden_groep:
        - media_player.keuken_hub
        - media_player.slaapkamer_hub
      media_player.zolder_groep:
        - media_player.zolder_mini_marleen
        - media_player.zolder_mini_martijn
  sequence:
    - variables:
        input_boolean: "{{ player | replace('media_player.', 'input_boolean.') }}"
        volume_old: "{{ state_attr(player, 'volume_level') | default(0.25, true) }}"
        spotify: >-
          {{ is_state_attr(player, 'app_name', 'Spotify') }}
        radio: >-
          {{ is_state_attr(player, 'app_name', 'TuneIn Free') or is_state_attr(player, 'media_content_id', 'http://icecast.omroep.nl/radio2-bb-aac') }}
        media_content: >-
          {{ state_attr(player, 'media_content_id') | default('geen', true) }}
        player_resume: >
          {% if is_state('media_player.huis_groep', 'playing') %}
            media_player.huis_groep
          {% elif ((player in speaker_groups['media_player.zolder_groep']) and is_state('media_player.zolder_groep', 'playing')) %}
            media_player.zolder_groep
          {% elif ((player in speaker_groups['media_player.boven_groep']) and is_state('media_player.boven_groep', 'playing')) %}
            media_player.boven_groep
          {% elif ((player in speaker_groups['media_player.beneden_groep']) and is_state('media_player.beneden_groep', 'playing')) %}
            media_player.beneden_groep
          {% else %}
            {{ player }}
          {% endif %}
    - alias: "Set volume"
      service: media_player.volume_set
      target:
        entity_id: "{{ player }}"
      data:
        volume_level: "{{ volume }}"
    - alias: "Play the right number of songs"
      repeat:
        count: "{{ number_of_plays }}"
        sequence:
          - variables:
              playlist: "{{ range(0,media|count) | list }}"
              exclude_list: "{{ states(input_text).split('|') | map('int') | list }}"
              to_play: "{{ playlist|reject('in', exclude_list) | list | random }}"
          - alias: "Remove first song, add new one"
            service: input_text.set_value
            target:
              entity_id: "{{ input_text }}"
            data:
              value: "{{ ((states(input_text).split('|') | map('int') | list)[1:] + [to_play]) | join('|') }}"
          - service: media_player.play_media
            target:
              entity_id: "{{ player }}"
            data:
              media_content_id: "{{ media[to_play] | replace('/media', 'media-source://media_source/local') }}"
              media_content_type: "audio/mp3"
              extra:
                title: "{{ (media[to_play].split('/')[5]).split('.')[0] }}"
                thumb: "{{ thumb }}"
          - alias: "Delay to make sure music is playing"
            delay: 7
          - alias: "Wait until music is stopped"
            wait_template: >
              {{
                is_state(player, 'idle')
                or is_state(player, 'off')
              }}
    - alias: "Short delay"
      delay: 1
    - alias: "Set volume to old volume"
      service: media_player.volume_set
      target:
        entity_id: "{{ player }}"
      data:
        volume_level: "{{ volume_old | float(0.25) }}"
    - alias: "Turn off media player"
      service: media_player.turn_off
      target:
        entity_id: "{{ player }}"
    - alias: "Resume old stream?"
      choose:
        - conditions: "{{ spotify }}"
          sequence:
            - alias: "Spotify hervatten"
              service: spotcast.start
              data:
                entity_id: "{{ player_resume }}"
        - conditions: "{{ radio }}"
          sequence:
            - alias: "Radio hervatten"
              service: media_player.play_media
              target:
                entity_id: "{{ player_resume }}"
              data:
                media_content_id: "{{ media_content }}"
                media_content_type: "music"
