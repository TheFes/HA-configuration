- trigger:
    - platform: event
      event_type: wifi_ignore
      id: ignore
    - platform: event
      event_type: wifi_always_guest
      id: always_guest
  sensor:
    - unique_id: cd9ca26d-0bfc-4990-9621-0ce5359cdf56
      name: Guest Wifi Ignore
      state: OK
      icon: mdi:wifi-cancel
      attributes:
        ignore: >
          {% set id = 'ignore' %}
          {% set current = this.attributes.get(id, []) %}
          {% if trigger.id == id %}
            {% set new = trigger.event.data.name | default(none, true) %}
            {% set new = [new] if new else [] %}
            {% if trigger.event.data.remove | default(false) %}
              {{ current | reject('in', new) | list }}
            {% else %}
              {{ current + new }}
            {% endif %}
          {% else %}
            {{ current }}
          {% endif %}
        always_guest: >
          {% set id = 'always_guest' %}
          {% set current = this.attributes.get(id, []) %}
          {% if trigger.id == id %}
            {% set new = trigger.event.data.name | default(none, true) %}
            {% set new = [new] if new else [] %}
            {% if trigger.event.data.remove | default(false) %}
              {{ current | reject('in', new) | list }}
            {% else %}
              {{ current + new }}
            {% endif %}
          {% else %}
            {{ current }}
          {% endif %}
- sensor:
    - unique_id: 4a803590-3649-473a-a10d-809a09fcfd2f
      name: Guest Wifi Active
      state: >
        {% set ignore = state_attr('sensor.guest_wifi_ignore', 'ignore')
                              | default([], true)
        %}
        {% set always = state_attr('sensor.guest_wifi_ignore', 'always_guest')
                              | default([], true)
        %}
        {% set guest = expand(integration_entities('fritz'))
            | selectattr('entity_id', 'search', '^device_tracker.')
            | selectattr('state', 'eq', 'home')
            | rejectattr('name', 'in', ignore)
            | selectattr('attributes.ip', 'defined')
            | selectattr('attributes.ip', 'search', '^192.168.189')
            | list
            | count
        %}
        {% set always = expand(integration_entities('fritz'))
            | selectattr('entity_id', 'search', '^device_tracker.')
            | selectattr('state', 'eq', 'home')
            | selectattr('name', 'in', always)
            | list
            | count
        %}
        {{ guest + always }}
      attributes:
        names: >
          {% set ignore = state_attr('sensor.guest_wifi_ignore', 'ignore')
                                | default([], true)
          %}
          {% set always = state_attr('sensor.guest_wifi_ignore', 'always_guest')
                                | default([], true)
          %}
          {% set guest = expand(integration_entities('fritz'))
              | selectattr('entity_id', 'search', '^device_tracker.')
              | selectattr('state', 'eq', 'home')
              | rejectattr('name', 'in', ignore)
              | selectattr('attributes.ip', 'defined')
              | selectattr('attributes.ip', 'search', '^192.168.189')
              | map(attribute='name')
              | list
          %}
          {% set always = expand(integration_entities('fritz'))
              | selectattr('entity_id', 'search', '^device_tracker.')
              | selectattr('state', 'eq', 'home')
              | selectattr('name', 'in', always)
              | map(attribute='name')
              | list
          %}
          {{ guest + always }}
