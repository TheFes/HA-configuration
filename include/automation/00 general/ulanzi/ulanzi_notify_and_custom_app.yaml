id: 10d5d325-1ed3-47a8-9352-b1b1d121802e
alias: "00 - Ulanzi notificatons and custom apps"
mode: queued
trigger:
  # apps - text
  - platform: state
    entity_id: weather.combined_hourly
    to: ~
    variables: &weather
      app: weather
      text: "{{ state_attr('weather.combined_hourly', 'temperature') }} Â°C"
      icon: "{{ states('weather.combined_hourly') }}"
      update: "{{ state_attr('weather.combined_hourly', 'temperature') is not none and 'weather.combined_hourly' | has_value }}"
  - platform: state
    entity_id: weather.combined_hourly
    attribute: temperature
    variables: *weather
  # notifications - text
  - platform: state
    entity_id: sensor.pixel_7_pro_last_notification
    to: ~
    variables:
      sender_name: !secret name_gf
      update: >
        {{
          trigger.to_state.attributes['package'] is defined
          and trigger.to_state.attributes['package'] == 'com.whatsapp'
          and trigger.to_state.attributes['android.title'] == sender_name
        }}
      icon: whatsapp
      text: >
        {%- if trigger.to_state.attributes['android.textLines'] is defined %}
          {{ trigger.to_state.attributes['android.textLines'] | last }}
        {%- else %}
          {{ trigger.to_state.attributes['android.text'] }}
        {%- endif %}
      repeat: 2
      textCase: 2
      pushIcon: 2
  - platform: state
    entity_id: binary_sensor.doorbell_button
    to: "on"
    variables:
      icon: dingdong
      text: Ding Dong!
  # notify - graph
  - platform: state
    entity_id: sensor.neerslag_buienalarm_regen_data
    to: ~
    variables:
      icon: rainy
      graph_max: >
        {%- set data = state_attr('sensor.neerslag_buienalarm_regen_data', 'data') %}
        {{ data.levels.heavy if data is not none else 1 }}
      graph_data: >
        {%- set data = state_attr('sensor.neerslag_buienalarm_regen_data', 'data') %}
        {%- set data = data.precip if data is not none else [] %}
        {{ data | map('multiply', 8/graph_max) | list }}
      graph_type: bar
      graph_color: [0, 0, 255]
      app: notify
      update: "{{ graph_data | sum > 0 }}"
variables:
  plot_graph: "{{ graph_data is defined and graph_data is not string and graph_data is iterable }}"
condition:
  - "{{ update | default(true) | bool(true) }}"
  - "{{ plot_graph or text is defined }}"
action:
  - alias: "Update custom app or send notification"
    service: mqtt.publish
    data:
      qos: 0
      retain: false
      topic: awtrix_dd3300/{{ 'notify' if app | default('notify') == 'notify' else ('custom/' ~ app) }}
      payload: >
        {%- set graph_type = graph_type | default('bar') %}
        {%- set icon = icon | default() %}
        {%- set color = graph_color | default() if plot_graph else text_color | default() %}
        {%- set data = (graph_data[:11] if icon else graph_data[:16]) if plot_graph else [] %}
        {%- set data = data | select('is_number') | map('round', 0) | map('int') | list %}
        {%- set graph_data = { graph_type: (data[:11] if icon else data[:16]) if plot_graph else [] }%}
        {%- set autoscale = not iif(graph_max | default(none)) if plot_graph else none %}
        {%- set data = dict(
                          graph_data,
                          text=text if not plot_graph else none,
                          repeat=repeat | default(3 if app == 'notify'),
                          rainbow=rainbow | default(none),
                          icon=icon | default(none),
                          pushIcon=pushIcon | default(0),
                          textCase=textCase | default(2),
                          color=color | default(),
                          autoscale = autoscale
                          )
        %}
        {%- set data = dict(data.items() | selectattr('1')) %}
        {{ data | to_json }}
