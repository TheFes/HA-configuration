{#
  set phrases to be used in the relative_time_period macro 
  one list item per language, each time fraction contains a list with the singular, plural and abbriviated phrase 
  combine contains the text to combine the last time fraction, and error the text to display on wrong date input
#}
{%- set _time_period_phrases = [
                                {
                                  'language': 'en',
                                  'phrases':
                                  {
                                    'year': ['year', 'years', 'yr'],
                                    'month': ['month', 'months', 'mth'],
                                    'week': ['week', 'weeks', 'wk'],
                                    'day': ['day', 'days', 'day'],
                                    'hour': ['hour', 'hours', 'hr'],
                                    'minute': ['minute', 'minutes', 'min'],
                                    'second': ['second', 'seconds', 'sec'],
                                    'combine': 'and',
                                    'error': 'Invalid date'
                                  }
                                },
                                {
                                  'language': 'pl',
                                  'phrases':
                                  {
                                    'year': ['rok', 'lat', 'r'],
                                    'month': ['miesiąc', 'miesięcy', 'msc'],
                                    'week': ['tydzień', 'tygodni', 'tyg'],
                                    'day': ['dzień', 'dni', 'dzień'],
                                    'hour': ['godzina', 'godzin', 'godz'],
                                    'minute': ['minuta', 'minut', 'min'],
                                    'second': ['sekunda', 'sekund', 'sek'],
                                    'combine': 'i',
                                    'error': 'Niepoprawna data'
                                  }
                                },
                                {
                                'language': 'fr',
                                'phrases':
                                  {
                                    'year': ['année', 'années', 'an'],
                                    'month': ['mois', 'mois', 'mois'],
                                    'week': ['semaine', 'semaines', 'sem'],
                                    'day': ['jour', 'jours', 'j'],
                                    'hour': ['heure', 'heures', 'h'],
                                    'minute': ['minute', 'minutes', 'min'],
                                    'second': ['seconde', 'secondes', 'sec'],
                                    'combine': 'et',
                                    'error': 'Date non valide'
                                    }
                                },
                                {
                                'language': 'it',
                                'phrases':
                                {
                                'year': ['anno', 'anni', 'aa'],
                                'month': ['mese', 'mesi', 'mm'],
                                'week': ['settimana', 'settimane', 'set'],
                                'day': ['giorno', 'giorni', 'gg'],
                                'hour': ['ora', 'ore', 'h'],
                                'minute': ['minuto', 'minuti', 'min'],
                                'second': ['secondo', 'secondi', 'sec'],
                                'combine': 'e',
                                'error': 'Data non valida'
                                }
                                },
                                {
                                  'language': 'nl',
                                  'phrases':
                                  {
                                    'year': ['jaar', 'jaar', 'jr'],
                                    'month': ['maand', 'maanden', 'mnd'],
                                    'week': ['week', 'weken', 'wk'],
                                    'day': ['dag', 'dagen', 'dg'],
                                    'hour': ['uur', 'uur', 'u'],
                                    'minute': ['minuut', 'minuten', 'min'],
                                    'second': ['seconde', 'seconden', 'sec'],
                                    'combine': 'en',
                                    'error': 'Ongeldige datum'
                                  }
                                },
                                {
                                  'language': 'de',
                                  'phrases':
                                  {
                                    'year': ['Jahr', 'Jahre', 'J.'],
                                    'month': ['Monat', 'Monate', 'M.'],
                                    'week': ['Woche', 'Wochen', 'Wo.'],
                                    'day': ['Tag', 'Tage', 'Tg.'],
                                    'hour': ['Stunde', 'Stunden', 'Std.'],
                                    'minute': ['Minute', 'Minuten', 'Min.'],
                                    'second': ['Sekunde', 'Sekunden', 'Sek.'],
                                    'combine': 'und',
                                    'error': 'Falsches Datum'
                                  }
                                },
                                {
                                  'language': 'pt',
                                  'phrases':
                                  {
                                    'year': ['ano', 'anos', 'aa'],
                                    'month': ['mês', 'meses', 'mm'],
                                    'week': ['semana', 'semanas', 'sem'],
                                    'day': ['dia', 'dias', 'd'],
                                    'hour': ['hora', 'horas', 'h'],
                                    'minute': ['minuto', 'minutos', 'min'],
                                    'second': ['segundo', 'segundos', 'seg'],
                                    'combine': 'e',
                                    'error': 'Data Inválida'
                                  }
                                },
                                {
                                  'language': 'dk',
                                  'phrases':
                                  {
                                    'year': ['år', 'år', 'år'],
                                    'month': ['måned', 'måneder', 'mnd'],
                                    'week': ['uge', 'uger', 'uge'],
                                    'day': ['dag', 'dage', 'dag'],
                                    'hour': ['time', 'timer', 't.'],
                                    'minute': ['minut', 'minuter', 'min.'],
                                    'second': ['sekund', 'sekunder', 'sek.'],
                                    'combine': 'og',
                                    'error': 'Ugyldig dato'
                                  }
                                }
                              ]
%}

{#
  macro to split a timedelta in years, months, weeks, days, hours, minutes, seconds
  used by the relative time plus macro, set up as a seperate macro so it can be reused
#}
{%- macro time_split(date, time, compare_date) -%}
  {# set defaults for variables #}
    {%- set date = date | as_local -%}
    {%- set time = time | default(true) | bool(true) -%}
    {%- set n = compare_date if compare_date is defined else now() -%}
    {%- set n = n if time else today_at() -%}
    {%- set a = [n, date] | max -%}
    {%- set b = [n, date] | min -%}
  {#- set time periods in seconds #}
    {%- set m, h, d, w = 60, 3600, 86400, 604800 -%}
  {#- set numer of years, and set lowest date using this number of years #}
    {%- set yrs = a.year - b.year - (1 if a.replace(year=b.year) < b else 0) -%}
    {%- set a = a.replace(year=a.year - yrs) -%}
  {#- set numer of months, and set lowest date using this number of months #}
    {%- set mth = (a.month - b.month - (1 if a.day < b.day else 0) + 12) % 12 -%}
    {%- set month_new = (((a.month - mth) + 12) % 12) | default(12, true) -%}
    {%- set day_max = ((a.replace(day=1, month=month_new) + timedelta(days=31)).replace(day=1) - timedelta(days=1)).day -%}
    {%- set a_temp = a.replace(month=month_new, day=[a.day, day_max]|min) -%}
    {%- set a = a_temp if a_temp <= a else a_temp.replace(year=a.year-1) -%}
  {#- set other time period variables #}
    {%- set s = (a - b).total_seconds() -%}
    {%- set wks = (s // w) | int -%}
    {%- set day = ((s - wks * w) // d) | int -%}
    {%- set hrs = ((s - wks * w - day * d) // h) | int -%}
    {%- set min = ((s - wks * w - day * d - hrs * h) // m) | int -%}
    {%- set sec = (s - wks * w - day * d - hrs * h - min * m) | int -%}
  {# output result #}
    {{- dict(y=yrs, mo=mth, w=wks, d=day, h=hrs, m=min, s=sec) | to_json -}}
{%- endmacro -%}

{# macro to output a timedelta in a readable format #}
{%- macro relative_time_plus(date, parts=1, abbr=false, verbose=false, language='en', compare_date=now(), week=true, time=true) -%}
  {#- set defaults for input if not entered #}
    {%- set date = date | as_datetime if date is string or date is number else date -%}
    {%- set compare_date = compare_date | as_datetime if compare_date is string or compare_date is number else compare_date -%}
  {#- select correct phrases bases on language input #}
    {%- set phrases = _time_period_phrases -%}
    {%- set languages = phrases | map(attribute='language') | list -%}
    {%- set language = iif(language in languages, language, 'en') -%}
    {%- set phr = phrases | selectattr('language', 'eq', language) | map(attribute='phrases') | list | first -%}
  {#- check for valid datetime (using as_timestamp) #}
    {%- if as_timestamp(date, default='error') != 'error' -%}
      {%- set date = date | as_local -%}
      {%- set parts = parts | int(1) -%}
      {%- set week = week | bool(true) -%}
      {%- set time = time | bool(true) -%}
      {%- set abbr = abbr | bool(false) or verbose | bool(false) -%}
      {%- set date = date if time else today_at().replace(year=date.year, month=date.month, day=date.day) -%}
      {%- set tp = time_split(date, time, compare_date) | from_json -%}
    {#- create mapping #}
      {%- set wk = tp.w if week else 0 -%}
      {%- set dy = tp.d if week else tp.d + tp.w * 7 -%}
      {#- macro to create the phrases for each time period -#}
        {%- macro set_phrase(value, time_period, abbr) -%}
            {%- set phr_abbr = phr[time_period][2] -%}
            {%- set phr_verb = phr[time_period][1] if value != 1 else phr[time_period][0] -%}
            {{- '{} {}'.format(value, phr_abbr if abbr else phr_verb) -}} 
        {%- endmacro -%}
      {%- set dur = dict(
                          yrs = dict(a=tp.y, d=set_phrase(tp.y, 'year', abbr)),
                          mth = dict(a=tp.mo, d=set_phrase(tp.mo, 'month', abbr)),
                          wks = dict(a=wk, d=set_phrase(wk, 'week', abbr)),
                          day = dict(a=dy, d=set_phrase(dy, 'day', abbr)),
                          hrs = dict(a=tp.h, d=set_phrase(tp.h, 'hour', abbr)),
                          min = dict(a=tp.m, d=set_phrase(tp.m, 'minute', abbr)),
                          sec = dict(a=tp.s, d=set_phrase(tp.s, 'second', abbr))
                        )
      -%}
    {#- find first non zero time period #}
      {%- set first = dur.items() | rejectattr('1.a', 'eq', 0) | map(attribute='0') | first | default('sec') -%}
    {#-select non zero items based on input #}
      {%- set index_first = (dur.keys() | reject('eq', 'wks' if not week else '') | list).index(first) -%}
      {%- set items = (dur.keys() | reject('eq', 'wks' if not week else '') | list)[index_first:index_first + parts] -%} 
      {%- set text = dur.items()
                            | selectattr('0', 'in', items)
                            | rejectattr('1.a', 'eq', 0)
                            | map(attribute='1.d')
                            | list
                            | default([dur.sec.d], true)
      -%} 
    {#- join texts in a string, using phr.combine for the last item #}
      {{- '{} {} {}'.format(text[:-1] | join(', '), phr.combine, text[-1]) if text | count > 1 else text | first -}}
    {%- else -%}
      {{- phr.error -}}
    {%- endif -%}
{%- endmacro -%}
