type: custom:mushroom-title-card
view_layout:
  grid-area: messages
title: >-
  {% if is_state('sensor.anniversary_' ~ user | lower, '0') %}
    ğŸ‰ Gefeliciteerd {{ user }}!! ğŸ‰
  {%- elif now() < today_at('06:00') %}
    Goedenacht {{ user }}
  {%- elif now() < today_at('12:00') %}
    Goedemorgen {{ user }}
  {%- elif now() < today_at('18:00') %}
    Goedemiddag {{ user }}
  {%- else %}
    Goedenavond {{ user }}
  {%- endif %}
alignment: center
subtitle: >-
  {% set ns = namespace(a=[]) %}
  {%- for item in expand(integration_entities('anniversaries')) %}
    {%- set d_h = item.attributes.days_until_half_anniversary | default(999, true) %}
    {%- set y = item.attributes.current_years | default(none, true) %}
    {%- set ns.a = ns.a + [ dict(name=item.name, days=[item.state | int, d_h] | min, year=y, half= d_h < item.state | int)] %}
  {%- endfor %}
  {%- for item in ns.a | sort(attribute='days') -%}
    {%- set n, d, y, h = item.name, item.days, item.year, item.half %}
    {%- set fixed_icons = {
                            'Eerste date': 'ğŸ’•',
                            'Sinterklaas': 'ğŸ'
                          } %}
    {%- set icons = ['ğŸ¥³', 'ğŸˆ', 'ğŸ°', 'ğŸŠ', 'ğŸ‰'] %}
    {%- set icon = fixed_icons[n] | default(icons | random, true) %}
    {%- if d == 0 %}
      {{ icon }} Vandaag: {{ n }} {% if y is not none %}({{ y + (0.5 if h else 0)}} jaar){% endif %}
    {%- elif d < 8 %}
      {{ icon }} Over {{ d }} dag{{'en' if d > 1 }}: {{ n }} {% if y is not none %}({{ y + (1.5 if h else 1)}} jaar){% endif %}
    {%- endif %}
  {%- endfor %}
  {%- set sensors = [ 'sensor.papier_en_pmd', 'sensor.rest_en_gft' ] %}
  {%- set active = expand(sensors)
                    | selectattr('state', 'in', ['Vandaag', 'Morgen'])
                    | map(attribute='entity_id')
                    | join 
  %}
  {%- if active | count > 0 %}
    ğŸš® {{ states(active) }}: {{ state_attr(active, 'friendly_name') }}
  {%- endif %}
  {%- if is_state('binary_sensor.dishwasher_active', 'on') %}
    {%- set time_set = as_local(as_datetime(states('input_datetime.dishwasher_program'))) %} 
    {%- if now() < time_set | as_local %}
      {%- set seconds = (time_set - now()).seconds %}
      {%- set hours = (seconds / 3600) | int %}
      {%- set minutes = (((seconds / 3600) - hours) * 60) | int %}
      {%- set program = states('input_select.dishwasher_program') %}
      {%- set extra = states('input_select.dishwasher_program_extra') %}
      {%- set extra = '' if extra == 'Normaal' else ' - ' ~ extra %}
      {%- set program = program ~ extra %}
      ğŸ’¦ Vaatwasser klaar rond {{ (states('input_datetime.dishwasher_program') | as_datetime).strftime('%H:%M') }} ({{ program }})
    {%- else %}
      ğŸ’¦ Vaatwasser is nu elk moment klaar
    {%- endif %}
  {%- endif %}
  {%- if is_state('sensor.wasmachine', 'on') %}
    {%- set h, m, s = states('sensor.wasmachine_remain_time').split(':') | map('int') %}
    {%- set total = h * 3600 + m *60 %}
    ğŸ§º Wasmachine klaar rond {{ (now() + timedelta(seconds = total)).strftime('%H:%M') }}
  {%- endif %}
  {%- if iif(states('input_text.eta_martijn')) %}
    {{ states('input_text.eta_martijn') }}
  {%- endif %}
  {%- if iif(states('input_text.eta_marleen')) %}
    {{ states('input_text.eta_marleen') }}
  {%- endif %}
