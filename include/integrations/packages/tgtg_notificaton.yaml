template:
  - sensor:
      - unique_id: ea9be49b-e147-49aa-b8fd-0c63258b3029
        name: TGTG boxes
        state: >
          {% set reject_list = ['0', 'unavailable', 'unknown'] %}
          {{ integration_entities('tgtg') | map('states') | reject('in', reject_list) | list | count }}
        icon: mdi:archive
        attributes:
          boxes: >
            {% set ns = namespace(box=[]) %}
            {% for e in integration_entities('tgtg') %}
              {% set ns.box = ns.box + [dict(entity_id=e, box=states[e].name.split(' - ')[0], state=states(e))] %}
            {% endfor %}
            {{ ns.box }}

automation:
  - id: b8f7c143-ca0d-4fbc-b98e-fec9870fd284
    alias: "00 - Alert for Too Good To Go"
    trigger:
      - platform: state
        entity_id: sensor.tgtg_boxes
        attribute: boxes
    variables:
      entity: >
        {% set changed = trigger.to_state.attributes.get('boxes', []) | reject('in', trigger.from_state.attributes.get('boxes', [])) | list %}
        {{ (changed | first).entity_id if iif(changed) else 'none' }}
      box: "{{ trigger.from_state.attributes.boxes[entity].box }}"
      from: "{{ trigger.from_state.attributes.boxes[entity].state }}"
      to: "{{ trigger.to_state.attributes.boxes[entity].state }}"
    condition:
      - "{{ entity != 'none' and from | is_number and to | is_number }}"
    action:
      - alias: "Send or dismiss"
        choose:
          - conditions: "{{ to == '0' }}"
            sequence:
              - alias: "Dismiss notification"
                service: notify.mobile_app_pixel_7_pro
                data:
                  message: "clear_notification"
                  data:
                    tag: TGTG-{{ entity }}
        default:
          - alias: "Send notification"
            service: notify.mobile_app_pixel_7_pro
            data:
              title: "{{ box}} beschikbaar"
              message: "Er {{ iif(to == '1','is', 'zijn') }} er nog {{ to }}"
              data:
                tag: TGTG-{{ entity }}
                channel: TGTG
                ttl: 0
                priority: high
                notification_icon: mdi:baguette
                clickAction: "{{ state_attr(entity, 'Item URL') }}"
